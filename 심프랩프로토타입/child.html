<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>매아리 그림일기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: 'Pretendard', sans-serif; background-color: #FAFAFA; color: #333; margin: 0; padding: 0; }
    header { position: sticky; top: 0; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px);
      border-bottom: 2px solid #FFE08C; display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; }
    header .logo { display: flex; align-items: center; gap: 10px; }
    header .logo-circle { background: #6BB7FF; width: 36px; height: 36px; border-radius: 50%; color: #fff;
      display: grid; place-items: center; font-weight: bold; font-size: 20px; }
    main { max-width: 480px; margin: auto; padding: 16px; padding-bottom: 90px; }
    .card { background: white; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; padding: 16px; }
    .card h2 { font-size: 18px; margin-bottom: 10px; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .grid div { text-align: center; cursor: pointer; transition: transform 0.2s; }
    .grid div:hover { transform: scale(1.02); }
    .grid img { width: 100%; height: 110px; object-fit: cover; border-radius: 12px; border: 1px solid #ddd; }
    .btn { border: none; border-radius: 16px; padding: 10px 14px; cursor: pointer; font-size: 15px; }
    .btn-primary { background: #6BB7FF; color: white; }
    .btn-outline { background: white; border: 1px solid #ccc; }
    .btn-yellow { background: #FFE08C; color: #333; }
    .btn-danger { background: #F28482; color: white; }
    nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; border-top: 2px solid #FFE08C; background: white; }
    nav button { flex: 1; padding: 12px 0; text-align: center; background: none; border: none; font-size: 14px; cursor: pointer; color: gray; }
    nav button.active { color: #6BB7FF; font-weight: bold; }
    canvas { background: #fff; border: 2px solid #FFE08C; border-radius: 16px; width: 100%; height: 200px; cursor: crosshair; display:block; }
    textarea { width: 100%; height: 80px; border-radius: 12px; border: 1px solid #ccc; padding: 8px; margin-top: 8px; font-family: inherit; resize: none; }
    select, input[type="date"] { width: 100%; border-radius: 12px; border: 1px solid #ccc; padding: 6px; margin-top: 8px; font-size: 14px; }
    .color-palette { display: flex; gap: 6px; margin-top: 8px; }
    .color-btn { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; box-shadow: 0 0 2px rgba(0,0,0,0.2); }
    .back-btn { background:#F9B4AB; color:#fff; padding:8px 12px; border:none; border-radius:12px; cursor:pointer; margin-bottom:10px; }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="logo.png" alt="매아리 로고" style="height:36px; border-radius:8px;">
      <div>
        <div style="color:#6BB7FF;font-weight:700;">매아리</div>
        <div style="color:#7DCFB6;font-size:12px;">매일 아이 이해하기</div>
      </div>
    </div>
    <div>🌤️</div>
  </header>

  <!-- 홈 화면 -->
  <main id="screen-home">
    <div class="card">
      <h2>오늘 그림일기</h2>
      <div class="grid" id="todayGrid"></div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-yellow" onclick="switchTab('draw')">🖍️ 그림일기 쓰기</button>
      </div>
    </div>
  </main>

  <!-- 그림 그리기 -->
  <main id="screen-draw" style="display:none;">
    <div class="card">
      <h2>그림 그리기</h2>
      <canvas id="drawCanvas"></canvas>

      <div class="color-palette">
        <div class="color-btn" style="background:black;" onclick="setColor('black')"></div>
        <div class="color-btn" style="background:red;" onclick="setColor('red')"></div>
        <div class="color-btn" style="background:blue;" onclick="setColor('blue')"></div>
        <div class="color-btn" style="background:green;" onclick="setColor('green')"></div>
        <div class="color-btn" style="background:pink;" onclick="setColor('pink')"></div>
        <div class="color-btn" style="background:orange;" onclick="setColor('orange')"></div>
        <button class="btn btn-outline" onclick="toggleEraser()">🧽 지우개</button>
      </div>

      <input type="range" id="brushSize" min="2" max="18" value="6" />
      <label>오늘 날짜</label>
      <input type="date" id="diaryDate" />
      <label>날씨</label>
      <select id="weather">
        <option value="☀️ 맑음">☀️ 맑음</option>
        <option value="🌧️ 비">🌧️ 비</option>
        <option value="🌤️ 흐림">🌤️ 흐림</option>
        <option value="🌈 맑고 무지개">🌈 맑고 무지개</option>
        <option value="❄️ 눈">❄️ 눈</option>
      </select>
      <textarea id="diaryText" placeholder="오늘의 이야기를 써주세요..."></textarea>
      <div style="margin-top:10px;display:flex;gap:6px;">
        <button class="btn btn-outline" onclick="switchTab('home')">취소</button>
        <button class="btn btn-yellow" onclick="uploadDrawing()">완성!</button>
      </div>
    </div>
  </main>

  <!-- 일기 보기 -->
  <main id="screen-view" style="display:none;">
    <div class="card" id="viewCard"></div>
    <button class="back-btn" onclick="switchTab('home')">← 홈으로</button>
  </main>

  <!-- 친구 피드 -->
  <main id="screen-friends" style="display:none;">
    <div class="card">
      <h2>친구들의 그림일기</h2>
      <div id="friendsFeed"></div>
    </div>
  </main>
  <!-- 내 프로필 -->
  <main id="screen-profile" style="display:none;">
    <div class="card">
      <h2>내 프로필</h2>
      <label>이름</label>
      <input id="myName" placeholder="이름 입력" />
      <label>학교</label>
      <input id="mySchool" placeholder="예: 매아리초등학교" />
      <div style="display:flex; gap:8px;">
        <div style="flex:1;">
          <label>학년</label>
          <select id="myGrade">
            <option value="">선택</option>
            <option>1학년</option><option>2학년</option><option>3학년</option>
            <option>4학년</option><option>5학년</option><option>6학년</option>
          </select>
        </div>
        <div style="flex:1;">
          <label>반</label>
          <select id="myClass">
            <option value="">선택</option>
            <option>1반</option><option>2반</option><option>3반</option>
            <option>4반</option><option>5반</option>
          </select>
        </div>
      </div>
      <label>자기소개</label>
      <textarea id="myIntro" placeholder="나를 소개해요!"></textarea>
      <button class="btn btn-primary" onclick="saveProfile()">💾 저장하기</button>
    </div>

    <div class="card" id="profilePreview" style="display:none;">
      <h2>프로필 미리보기</h2>
      <p><strong>이름:</strong> <span id="previewName"></span></p>
      <p><strong>학교:</strong> <span id="previewSchool"></span></p>
      <p><strong>학년/반:</strong> <span id="previewGrade"></span> <span id="previewClass"></span></p>
      <p><strong>소개:</strong> <span id="previewIntro"></span></p>
      <button class="btn btn-yellow" onclick="editProfile()">✏️ 수정하기</button>
    </div>
  </main>
  
  <nav>
    <button id="tab-home" class="active" onclick="switchTab('home')">🏠 홈</button>
    <button id="tab-draw" onclick="switchTab('draw')">🎨 그리기</button>
    <button id="tab-friends" onclick="switchTab('friends')">👫 친구들</button>
    <button id="tab-profile" onclick="switchTab('profile')">👤 내 프로필</button>
  </nav>

<script>
  const todayGrid = document.getElementById('todayGrid');
  const canvas = document.getElementById('drawCanvas');
  const ctx = canvas.getContext('2d');
  const brushSize = document.getElementById('brushSize');
  const diaryText = document.getElementById('diaryText');
  const diaryDate = document.getElementById('diaryDate');
  const weatherSel = document.getElementById('weather');
  const viewCard = document.getElementById('viewCard');
  const friendsFeed = document.getElementById('friendsFeed');

  let drawing = false;
  let drawings = [];
  let currentColor = 'black';
  let eraserMode = false;
  let editDiary = null;
  let lastX = 0, lastY = 0;

  // 캔버스 크기 자동 조정
  function setCanvasSize() {
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
  }
  window.addEventListener('load', setCanvasSize);
  window.addEventListener('resize', setCanvasSize);

  // 공통 좌표 계산 (터치/마우스 모두 지원)
  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    if (e.touches && e.touches.length > 0) {
      return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
    } else {
      return [e.clientX - rect.left, e.clientY - rect.top];
    }
  }

  function startDraw(e) {
    drawing = true;
    const [x, y] = getPos(e);
    [lastX, lastY] = [x, y];
  }

  function draw(e) {
    if (!drawing) return;
    e.preventDefault(); // 모바일에서 스크롤 방지
    const [x, y] = getPos(e);
    ctx.strokeStyle = eraserMode ? "#fff" : currentColor;
    ctx.lineWidth = brushSize.value;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    [lastX, lastY] = [x, y];
  }

  function stopDraw() {
    drawing = false;
  }

  // 마우스 이벤트
  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDraw);
  canvas.addEventListener('mouseout', stopDraw);

  // 터치 이벤트 (모바일 대응)
  canvas.addEventListener('touchstart', startDraw);
  canvas.addEventListener('touchmove', draw, { passive: false }); // preventDefault() 활성화
  canvas.addEventListener('touchend', stopDraw);

// 색상, 지우개 기능
function setColor(color) {
  currentColor = color;
  eraserMode = false;

  // 모든 색상 버튼 초기화
  document.querySelectorAll('.color-btn').forEach(btn => {
    btn.style.outline = '';
    btn.style.boxShadow = '';
  });

  // 선택된 색상 강조 (테두리)
  const selected = Array.from(document.querySelectorAll('.color-btn'))
    .find(btn => btn.style.background === color);
  if (selected) {
    selected.style.outline = '3px solid #FFE08C';
    selected.style.boxShadow = '0 0 6px #FFE08C';
  }

  // 지우개 버튼 스타일 초기화
  const eraserBtn = document.querySelector('.color-palette button');
  if (eraserBtn) {
    eraserBtn.style.background = '';
    eraserBtn.style.color = '';
    eraserBtn.style.border = '1.5px solid #ccc';
  }
}

function toggleEraser() {
  eraserMode = !eraserMode;
  const eraserBtn = document.querySelector('.color-palette button');

  if (eraserMode) {
    eraserBtn.style.background = '#FFE08C';  // 크림 옐로 강조
    eraserBtn.style.color = '#333';
    eraserBtn.style.border = '2px solid #E1B000';
  } else {
    eraserBtn.style.background = '';
    eraserBtn.style.color = '';
    eraserBtn.style.border = '1.5px solid #ccc';
  }

  // 색상 버튼 강조 해제
  document.querySelectorAll('.color-btn').forEach(btn => {
    btn.style.outline = '';
    btn.style.boxShadow = '';
  });
}


  // 탭 전환
  function switchTab(tab) {
    document.querySelectorAll('main').forEach(m => m.style.display = 'none');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(`screen-${tab}`).style.display = 'block';
    const tabBtn = document.getElementById(`tab-${tab}`);
    if (tabBtn) tabBtn.classList.add('active');
    if (tab === 'draw') setTimeout(setCanvasSize, 100);
    if (tab === 'friends') renderFriendsFeed();
    if (tab === 'profile') loadProfile();
  }

  // 업로드 및 일기 렌더링
  function uploadDrawing() {
    const imageData = canvas.toDataURL();
    const text = diaryText.value.trim() || "무제";
    const date = diaryDate.value || new Date().toISOString().split('T')[0];
    const weather = weatherSel.value;
    if (editDiary) {
      editDiary.imageData = imageData;
      editDiary.text = text;
      editDiary.date = date;
      editDiary.weather = weather;
      editDiary = null;
    } else {
      drawings.push({ imageData, text, date, weather });
    }
    renderGrid();
    diaryText.value = "";
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    switchTab('home');
  }

  function renderGrid() {
    todayGrid.innerHTML = "";
    drawings.forEach(diary => {
      const div = document.createElement('div');
      div.innerHTML = `<img src="${diary.imageData}"><div style="font-size:11px;color:gray;">${diary.date}<br>${diary.weather}</div>`;
      div.onclick = () => openDiary(diary);
      todayGrid.prepend(div);
    });
  }

    // 프로필 저장
    function saveProfile() {
      const name = myName.value;
      const school = mySchool.value;
      const grade = myGrade.value;
      const classNum = myClass.value;
      const intro = myIntro.value;

      const profile = { name, school, grade, classNum, intro };
      localStorage.setItem('maeariProfile', JSON.stringify(profile));
      alert("프로필이 저장되었습니다 ✅");
      showProfilePreview(profile);
    }

    // 프로필 로드
    function loadProfile() {
      const saved = localStorage.getItem('maeariProfile');
      if (!saved) return;
      const p = JSON.parse(saved);
      myName.value = p.name;
      mySchool.value = p.school;
      myGrade.value = p.grade;
      myClass.value = p.classNum;
      myIntro.value = p.intro;
      showProfilePreview(p);
    }

    // 미리보기 표시
    function showProfilePreview(p) {
      document.getElementById('profilePreview').style.display = 'block';
      document.getElementById('previewName').innerText = p.name;
      document.getElementById('previewSchool').innerText = p.school;
      document.getElementById('previewGrade').innerText = p.grade;
      document.getElementById('previewClass').innerText = p.classNum;
      document.getElementById('previewIntro').innerText = p.intro;
    }

    // 수정모드로 돌아가기
    function editProfile() {
      document.getElementById('profilePreview').style.display = 'none';
    }

    function openDiary(diary) {
      switchTab('view');
      viewCard.innerHTML = `
        <h2>${diary.date} / ${diary.weather}</h2>
        <img src="${diary.imageData}" style="width:100%;border-radius:12px;border:1px solid #ddd;margin-bottom:10px;">
        <p style="font-size:15px;">${diary.text}</p>
        <div style="display:flex;gap:6px;justify-content:flex-end;">
          <button class="btn btn-yellow" onclick="editExistingDiary('${diary.date}')">✏️ 수정</button>
          <button class="btn btn-danger" onclick="deleteDiary('${diary.date}')">🗑️ 삭제</button>
        </div>
      `;
    }

    function deleteDiary(date) {
      if (!confirm("정말 이 그림일기를 삭제할까요?")) return;
      drawings = drawings.filter(d => d.date !== date);
      renderGrid();
      alert("그림일기가 삭제되었습니다 🗑️");
      switchTab('home');
    }

    function editExistingDiary(date) {
      const diary = drawings.find(d => d.date === date);
      if (!diary) return;
      editDiary = diary;
      switchTab('draw');
      diaryText.value = diary.text;
      diaryDate.value = diary.date;
      weatherSel.value = diary.weather;
      const img = new Image();
      img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      img.src = diary.imageData;
    }

    // --- 친구들 SNS 피드 ---
    const friendPosts = [
      { name: "민수", date: "2025-10-15", weather: "☀️ 맑음", image: "https://picsum.photos/seed/f1/400/250", text: "학교 운동장에서 친구들과 축구했어요!", likes: 12, comments: 3 },
      { name: "소연", date: "2025-10-16", weather: "🌧️ 비", image: "https://picsum.photos/seed/f2/400/250", text: "비 오는 날 창문에 그림을 그렸어요 ☔", likes: 7, comments: 1 },
      { name: "지호", date: "2025-10-17", weather: "🌈 맑고 무지개", image: "https://picsum.photos/seed/f3/400/250", text: "하늘에 무지개가 떴어요! 너무 예뻐요 🌈", likes: 22, comments: 4 }
    ];

    function renderFriendsFeed() {
      friendsFeed.innerHTML = "";
      friendPosts.forEach(post => {
        const div = document.createElement("div");
        div.className = "card";
        div.style.marginBottom = "16px";
        div.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
            <div style="background:#6BB7FF;width:36px;height:36px;border-radius:50%;color:#fff;display:grid;place-items:center;font-weight:bold;">
              ${post.name[0]}
            </div>
            <div>
              <div style="font-weight:600;">${post.name}</div>
              <div style="font-size:12px;color:gray;">${post.date} / ${post.weather}</div>
            </div>
          </div>
          <img src="${post.image}" style="width:100%;border-radius:12px;border:1px solid #ddd;margin-bottom:8px;">
          <p style="font-size:15px;">${post.text}</p>
          <div style="display:flex;justify-content:space-around;margin-top:8px;font-size:14px;color:#6BB7FF;">
            <button class="btn btn-outline" onclick="alert('좋아요! ❤️')">❤️ ${post.likes}</button>
            <button class="btn btn-outline" onclick="alert('댓글 기능은 준비중이에요 💬')">💬 ${post.comments}</button>
            <button class="btn btn-outline" onclick="alert('공유 기능은 준비중이에요 🔁')">🔁 공유</button>
          </div>
        `;
        friendsFeed.appendChild(div);
      });
    }
  </script>
</body>
</html>
