<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>êµì‚¬ìš© ë§¤ì•„ë¦¬</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-[#FAFAFA] text-[#333]">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      // === ìƒìˆ˜ ===
      const STAMP_SRC = 'stamp.png'; // ë„ì¥ ì´ë¯¸ì§€ (ë™ì¼ í´ë”)

      // === ê³µìœ  ì €ì¥ì†Œ helpers ===
      const loadAllDiaries = () => {
        try { return JSON.parse(localStorage.getItem("maeariDiaries")) || []; }
        catch(e){ return []; }
      };
      const saveAllDiaries = (arr) => localStorage.setItem("maeariDiaries", JSON.stringify(arr));

      // ìœ„í—˜ë„ ë±ƒì§€
      function RiskBadge({ risk }) {
        const style =
          risk === "ìœ„í—˜"
            ? "bg-red-100 text-red-700 border border-red-300"
            : risk === "ì£¼ì˜"
            ? "bg-amber-100 text-amber-700 border border-amber-300"
            : "bg-green-100 text-green-700 border border-green-300";
        const emoji = risk === "ìœ„í—˜" ? "âš ï¸" : risk === "ì£¼ì˜" ? "ğŸŸ¡" : "ğŸŸ¢";
        return (
          <span className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-semibold shadow-sm ${style}`}>
            {emoji} {risk}
          </span>
        );
      }

      function App() {
        // ì˜ˆì‹œ í•™ìƒë“¤ 8ëª… ìœ ì§€
        const [students, setStudents] = useState(() => {
          const saved = localStorage.getItem("students");
          return saved
            ? JSON.parse(saved)
            : Array.from({ length: 8 }, (_, i) => ({
                id: i + 1,
                name: `í•™ìƒ ${i + 1}`,
                risk: ["ì •ìƒ", "ì£¼ì˜", "ìœ„í—˜"][i % 3],
                recent: `2025-10-${String(10 + i).padStart(2, "0")}`,
                img: `https://picsum.photos/seed/student_${i}/200/200`,
              }));
        });

        const [selectedId, setSelectedId] = useState(null);
        const [filterRisk, setFilterRisk] = useState("ì „ì²´");
        const [showAdd, setShowAdd] = useState(false);
        const [newName, setNewName] = useState("");
        const [newRisk, setNewRisk] = useState("ì •ìƒ");

        useEffect(() => { localStorage.setItem("students", JSON.stringify(students)); }, [students]);

        const selectedStudent = selectedId === null ? null : students.find(s => s.id === selectedId) || null;
        useEffect(() => { if (selectedId !== null && !students.some(s => s.id === selectedId)) setSelectedId(null); }, [students, selectedId]);

        const filteredStudents = filterRisk === "ì „ì²´" ? students : students.filter(s => s.risk === filterRisk);

        const addStudent = () => {
          if (!newName.trim()) { alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
          const newStudent = {
            id: Date.now(),
            name: newName.trim(),
            risk: newRisk,
            recent: new Date().toISOString().split("T")[0],
            img: `https://picsum.photos/seed/${Math.random()}/200/200`,
          };
          setStudents([...students, newStudent]);
          setShowAdd(false); setNewName(""); setNewRisk("ì •ìƒ");
        };
        const deleteStudent = (id) => {
          if (confirm("ì •ë§ ì´ í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            setStudents(students.filter(s => s.id !== id));
            setSelectedId(null);
          }
        };

        return (
          <div className="min-h-screen">
            <header className="px-6 py-4 bg-[#A4D4AE]/60 backdrop-blur border-b flex justify-between items-center">
              <div className="text-2xl font-bold text-[#2b6240]">êµì‚¬ìš© ë§¤ì•„ë¦¬</div>
              <button onClick={() => setShowAdd(true)} className="bg-[#6BB7FF] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#5aa7f0]">
                â• í•™ìƒ ì¶”ê°€
              </button>
            </header>

            <main className="max-w-6xl mx-auto p-6 space-y-6">
              {selectedStudent === null ? (
                <>
                  {/* ìœ„í—˜ë„ í•„í„° */}
                  <div className="flex gap-3 mb-6">
                    {["ì „ì²´", "ìœ„í—˜", "ì£¼ì˜", "ì •ìƒ"].map((r) => {
                      const count = r === "ì „ì²´" ? students.length : students.filter(s => s.risk === r).length;
                      const color = r === "ìœ„í—˜" ? "#F87171" : r === "ì£¼ì˜" ? "#FBBF24" : r === "ì •ìƒ" ? "#34D399" : "#6BB7FF";
                      const isActive = filterRisk === r;
                      return (
                        <button key={r} onClick={() => setFilterRisk(r)}
                          className={`flex-1 rounded-xl p-3 text-center font-semibold transition ${isActive ? "text-white scale-105 shadow-lg" : "text-white/80"}`}
                          style={{ backgroundColor: color, opacity: isActive ? 1 : 0.8 }}>
                          {r} {count}ëª…
                        </button>
                      );
                    })}
                  </div>

                  {/* í•™ìƒ ëª©ë¡ */}
                  {filteredStudents.length > 0 ? (
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-5">
                      {filteredStudents.map((s) => (
                        <div key={s.id} onClick={() => setSelectedId(s.id)}
                          className={`rounded-2xl border-4 p-4 hover:shadow-lg transition text-center cursor-pointer ${
                            s.risk === "ìœ„í—˜" ? "border-red-400 bg-red-50"
                              : s.risk === "ì£¼ì˜" ? "border-amber-400 bg-amber-50"
                              : "border-green-400 bg-green-50"}`}>
                          <img src={s.img} alt={s.name}
                            className="w-20 h-20 rounded-full mx-auto mb-2 object-cover border border-white shadow-sm" />
                          <div className="font-medium text-base">{s.name}</div>
                          <div className="mt-2"><RiskBadge risk={s.risk} /></div>
                          <div className="text-xs text-gray-500 mt-2">ìµœê·¼: {s.recent}</div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center text-gray-400 py-10">í•´ë‹¹ ë²”ì£¼ì˜ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>
                  )}
                </>
              ) : (
                <StudentDetail
                  student={selectedStudent}
                  onBack={() => setSelectedId(null)}
                  onDelete={() => deleteStudent(selectedStudent.id)}
                />
              )}
            </main>

            {/* í•™ìƒ ì¶”ê°€ ëª¨ë‹¬ */}
            {showAdd && (
              <div className="fixed inset-0 bg-black/40 flex justify-center items-center">
                <div className="bg-white p-6 rounded-2xl shadow-xl w-80 space-y-4">
                  <h2 className="text-lg font-semibold text-center text-[#2b6240]">ğŸ‘©â€ğŸ« í•™ìƒ ì¶”ê°€</h2>
                  <input type="text" className="border rounded-lg px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥"
                         value={newName} onChange={(e) => setNewName(e.target.value)} />
                  <select className="border rounded-lg px-3 py-2 w-full" value={newRisk}
                          onChange={(e) => setNewRisk(e.target.value)}>
                    <option value="ì •ìƒ">ì •ìƒ</option>
                    <option value="ì£¼ì˜">ì£¼ì˜</option>
                    <option value="ìœ„í—˜">ìœ„í—˜</option>
                  </select>
                  <div className="flex justify-end gap-2">
                    <button onClick={() => setShowAdd(false)} className="px-3 py-2 rounded-lg border border-gray-300 text-gray-600">ì·¨ì†Œ</button>
                    <button onClick={addStudent} className="px-3 py-2 rounded-lg bg-[#6BB7FF] text-white hover:bg-[#5aa7f0]">ì¶”ê°€</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      // í•™ìƒ ìƒì„¸: ì•„ì´ ì¼ê¸° ë¡œë“œ â†’ ë„ì¥/ì½”ë©˜íŠ¸ ë‚¨ê¸°ê¸°
      function StudentDetail({ student, onBack, onDelete }) {
        const { useState, useEffect, useMemo } = React;
        const [selectedIdx, setSelectedIdx] = useState(0);
        const [diaries, setDiaries] = useState([]);
        const [commentDraft, setCommentDraft] = useState("");
        const [stampChecked, setStampChecked] = useState(false);

        // ì´ í•™ìƒì˜ ì¼ê¸°ë¥¼ ê³µìœ  ì €ì¥ì†Œì—ì„œ ë¡œë“œ
        useEffect(() => {
          const all = loadAllDiaries();
          const list = all.filter(d => d.studentName === student.name)
                          .sort((a,b)=> (a.date < b.date ? 1 : -1));
          setDiaries(list);
          if (list.length > 0) {
            setSelectedIdx(0);
            setCommentDraft(list[0].teacherComment || "");
            setStampChecked(!!list[0].stamp);
          }
        }, [student]);

        // ì„ íƒ ë³€ê²½ ì‹œ ë“œë˜í”„íŠ¸ ë™ê¸°í™”
        useEffect(() => {
          if (diaries.length === 0) return;
          const cur = diaries[selectedIdx];
          setCommentDraft(cur?.teacherComment || "");
          setStampChecked(!!cur?.stamp);
        }, [selectedIdx]);

        const flagged = useMemo(() => {
          const dangerWords = ["ìš¸ì—ˆì–´ìš”", "ë¬´ì„œ", "ì•„íŒŒ", "ì‹«ì–´", "ê´´ë¡­"];
          return diaries.filter(d => dangerWords.some(w => (d.text || "").includes(w)));
        }, [diaries]);

        const saveFeedback = () => {
          if (diaries.length === 0) return;
          const target = diaries[selectedIdx];
          const all = loadAllDiaries();
          const idx = all.findIndex(d => d.studentName===target.studentName && d.date===target.date);
          if (idx >= 0) {
            all[idx] = { ...all[idx], teacherComment: commentDraft, stamp: stampChecked };
            saveAllDiaries(all);
            const newList = [...diaries];
            newList[selectedIdx] = all[idx];
            setDiaries(newList);
            alert("í”¼ë“œë°±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. âœ… (ì•„ì´ í™”ë©´ì—ë„ ë°˜ì˜ë©ë‹ˆë‹¤)");
          }
        };

        return (
          <div className="space-y-5">
            <div className="flex items-center gap-3">
              <button className="p-2 hover:bg-gray-100 rounded-lg" onClick={onBack}>â¬… ë’¤ë¡œ</button>
              <h2 className="text-2xl font-semibold text-[#2b6240]">{student.name} ê·¸ë¦¼ì¼ê¸°</h2>
              <button onClick={onDelete} className="ml-auto text-red-500 text-sm hover:underline">ğŸ—‘ í•™ìƒ ì‚­ì œ</button>
            </div>

            {/* ìœ„í—˜ íƒì§€ ìš”ì•½ */}
            <div className="border rounded-2xl bg-white p-4 space-y-2">
              <div className="font-semibold text-[#8a3a3a]">âš ï¸ ìœ„í—˜ ê°ì§€ ì¼ê¸°: {flagged.length}ê±´</div>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {flagged.length > 0 ? flagged.map((d) => (
                  <div key={d.date}
                       onClick={() => setSelectedIdx(diaries.findIndex(x => x.date===d.date))}
                       className="flex-shrink-0 w-36 border rounded-xl overflow-hidden cursor-pointer hover:ring-2 hover:ring-[#FCA5A5]">
                    <img src={d.imageData} className="w-full h-24 object-cover" alt={d.date}/>
                    <div className="p-1 text-xs text-center text-gray-600">{d.date}</div>
                  </div>
                )) : <div className="text-gray-400 text-sm">ìœ„í—˜ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
              </div>
            </div>

            {/* ì¼ê¸° ëª©ë¡ + ìƒì„¸ */}
            {diaries.length === 0 ? (
              <div className="text-center text-gray-400 py-10">
                ì´ í•™ìƒì˜ ê·¸ë¦¼ì¼ê¸°ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. (ì•„ì´ ì•±ì—ì„œ ì‘ì„±í•˜ë©´ ì—¬ê¸°ì— ë³´ì—¬ìš”)
              </div>
            ) : (
              <>
                {/* ì¸ë„¤ì¼ ë¦¬ìŠ¤íŠ¸ */}
                <div className="flex gap-3 overflow-x-auto">
                  {diaries.map((d, i) => (
                    <div key={d.date}
                         onClick={() => setSelectedIdx(i)}
                         className={`flex-shrink-0 w-32 border rounded-xl overflow-hidden cursor-pointer
                          ${i===selectedIdx ? "ring-2 ring-[#6BB7FF]" : "hover:ring-2 hover:ring-[#93C5FD]"}`}>
                      <img src={d.imageData} className="w-full h-24 object-cover" alt={d.title}/>
                      <div className="p-1 text-[11px] text-center text-gray-600">
                        {d.date}<br/>{d.title || "ì œëª© ì—†ìŒ"}
                      </div>
                    </div>
                  ))}
                </div>

                {/* ìƒì„¸ + í”¼ë“œë°± */}
                <div className="grid md:grid-cols-2 gap-5">
                  <div className="border rounded-2xl bg-white overflow-hidden">
                    <img src={diaries[selectedIdx].imageData} className="w-full object-cover max-h-[360px]" alt="ê·¸ë¦¼"/>
                    <div className="p-4 space-y-1 text-sm">
                      <div className="font-semibold">{diaries[selectedIdx].title || "ì œëª© ì—†ìŒ"}</div>
                      <div className="text-gray-500">{diaries[selectedIdx].date} / {diaries[selectedIdx].weather || ""}</div>
                      <div className="mt-2 whitespace-pre-wrap">{diaries[selectedIdx].text}</div>
                    </div>
                  </div>

                  <div className="border rounded-2xl bg-white p-4 space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="font-semibold">ì„ ìƒë‹˜ í”¼ë“œë°±</div>
                      <label className="inline-flex items-center gap-2 text-sm">
                        <input type="checkbox" className="w-4 h-4"
                               checked={stampChecked}
                               onChange={(e)=>setStampChecked(e.target.checked)}/>
                        <span className="px-2 py-1 rounded-lg bg-yellow-100 border border-yellow-300">
                          ì°¸ ì˜í–ˆì–´ìš” ë„ì¥
                        </span>
                        <img src={STAMP_SRC} alt="ë„ì¥ ë¯¸ë¦¬ë³´ê¸°" className="w-8 h-8 rounded" />
                      </label>
                    </div>
                    <textarea
                      className="w-full border rounded-lg p-3 min-h-[140px]"
                      placeholder="ì•„ì´ì—ê²Œ ë‚¨ê¸¸ ì½”ë©˜íŠ¸ë¥¼ ì ì–´ì£¼ì„¸ìš”"
                      value={commentDraft}
                      onChange={(e)=>setCommentDraft(e.target.value)}
                    ></textarea>
                    <div className="flex justify-end gap-2">
                      <button className="px-3 py-2 rounded-lg border border-gray-300 text-gray-600" onClick={()=>onBack()}>ëª©ë¡</button>
                      <button className="px-3 py-2 rounded-lg bg-[#6BB7FF] text-white hover:bg-[#5aa7f0]" onClick={saveFeedback}>
                        ì €ì¥
                      </button>
                    </div>
                    <p className="text-xs text-gray-500">
                      ì €ì¥í•˜ë©´ ì•„ì´ ì•±(child.html)ì—ì„œë„ ë„ì¥/ì½”ë©˜íŠ¸ê°€ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.
                    </p>
                  </div>
                </div>
              </>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
