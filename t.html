<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>교사용 매아리</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-[#FAFAFA] text-[#333]">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // 위험도 뱃지
      function RiskBadge({ risk }) {
        const style =
          risk === "위험"
            ? "bg-red-100 text-red-700 border border-red-300"
            : risk === "주의"
            ? "bg-amber-100 text-amber-700 border border-amber-300"
            : "bg-green-100 text-green-700 border border-green-300";
        const emoji = risk === "위험" ? "⚠️" : risk === "주의" ? "🟡" : "🟢";
        return (
          <span className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-semibold shadow-sm ${style}`}>
            {emoji} {risk}
          </span>
        );
      }

      function App() {
        const [students, setStudents] = useState(() => {
          const saved = localStorage.getItem("students");
          return saved
            ? JSON.parse(saved)
            : Array.from({ length: 8 }, (_, i) => ({
                id: i + 1,
                name: `학생 ${i + 1}`,
                risk: ["정상", "주의", "위험"][i % 3],
                recent: `2025-10-${String(10 + i).padStart(2, "0")}`,
                img: `https://picsum.photos/seed/student_${i}/200/200`,
              }));
        });

        // ✅ 인덱스가 아닌 id로 선택 상태 관리
        const [selectedId, setSelectedId] = useState(null);
        const [filterRisk, setFilterRisk] = useState("전체");
        const [showAdd, setShowAdd] = useState(false);
        const [newName, setNewName] = useState("");
        const [newRisk, setNewRisk] = useState("정상");

        useEffect(() => {
          localStorage.setItem("students", JSON.stringify(students));
        }, [students]);

        // ✅ 선택된 학생 객체
        const selectedStudent = selectedId === null
          ? null
          : students.find((s) => s.id === selectedId) || null;

        // ✅ 선택된 학생이 데이터에서 사라졌을 때 자동 해제 (삭제/필터 변경 대비)
        useEffect(() => {
          if (selectedId !== null && !students.some(s => s.id === selectedId)) {
            setSelectedId(null);
          }
        }, [students, selectedId]);

        const filteredStudents =
          filterRisk === "전체"
            ? students
            : students.filter((s) => s.risk === filterRisk);

        // 학생 추가
        const addStudent = () => {
          if (!newName.trim()) {
            alert("이름을 입력하세요.");
            return;
          }
          const newStudent = {
            id: Date.now(),
            name: newName.trim(),
            risk: newRisk,
            recent: new Date().toISOString().split("T")[0],
            img: `https://picsum.photos/seed/${Math.random()}/200/200`,
          };
          setStudents([...students, newStudent]);
          setShowAdd(false);
          setNewName("");
          setNewRisk("정상");
        };

        // 학생 삭제
        const deleteStudent = (id) => {
          if (confirm("정말 이 학생을 삭제하시겠습니까?")) {
            const updated = students.filter((s) => s.id !== id);
            setStudents(updated);
            setSelectedId(null); // 상세 열려 있었다면 목록으로 복귀
          }
        };

        return (
          <div className="min-h-screen">
            <header className="px-6 py-4 bg-[#A4D4AE]/60 backdrop-blur border-b flex justify-between items-center">
              <div className="text-2xl font-bold text-[#2b6240]">교사용 매아리</div>
              <button
                onClick={() => setShowAdd(true)}
                className="bg-[#6BB7FF] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#5aa7f0]"
              >
                ➕ 학생 추가
              </button>
            </header>

            <main className="max-w-6xl mx-auto p-6 space-y-6">
              {/* ✅ 목록/상세 분기: id 기준 */}
              {selectedStudent === null ? (
                <>
                  {/* 위험도 필터 */}
                  <div className="flex gap-3 mb-6">
                    {["전체", "위험", "주의", "정상"].map((r) => {
                      const count =
                        r === "전체"
                          ? students.length
                          : students.filter((s) => s.risk === r).length;
                      const color =
                        r === "위험"
                          ? "#F87171"
                          : r === "주의"
                          ? "#FBBF24"
                          : r === "정상"
                          ? "#34D399"
                          : "#6BB7FF";
                      const isActive = filterRisk === r;
                      return (
                        <button
                          key={r}
                          onClick={() => setFilterRisk(r)}
                          className={`flex-1 rounded-xl p-3 text-center font-semibold transition ${
                            isActive ? "text-white scale-105 shadow-lg" : "text-white/80"
                          }`}
                          style={{ backgroundColor: color, opacity: isActive ? 1 : 0.8 }}
                        >
                          {r} {count}명
                        </button>
                      );
                    })}
                  </div>

                  {/* 학생 목록 */}
                  {filteredStudents.length > 0 ? (
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-5">
                      {filteredStudents.map((s) => (
                        <div
                          key={s.id}
                          onClick={() => setSelectedId(s.id)}  // ✅ id 저장
                          className={`rounded-2xl border-4 p-4 hover:shadow-lg transition text-center cursor-pointer ${
                            s.risk === "위험"
                              ? "border-red-400 bg-red-50"
                              : s.risk === "주의"
                              ? "border-amber-400 bg-amber-50"
                              : "border-green-400 bg-green-50"
                          }`}
                        >
                          <img
                            src={s.img}
                            alt={s.name}
                            className="w-20 h-20 rounded-full mx-auto mb-2 object-cover border border-white shadow-sm"
                          />
                          <div className="font-medium text-base">{s.name}</div>
                          <div className="mt-2">
                            <RiskBadge risk={s.risk} />
                          </div>
                          <div className="text-xs text-gray-500 mt-2">
                            최근: {s.recent}
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center text-gray-400 py-10">
                      해당 범주의 학생이 없습니다.
                    </div>
                  )}
                </>
              ) : (
                <StudentDetail
                  student={selectedStudent}
                  onBack={() => setSelectedId(null)}
                  onDelete={() => deleteStudent(selectedStudent.id)}
                />
              )}
            </main>

            {/* 학생 추가 모달 */}
            {showAdd && (
              <div className="fixed inset-0 bg-black/40 flex justify-center items-center">
                <div className="bg-white p-6 rounded-2xl shadow-xl w-80 space-y-4">
                  <h2 className="text-lg font-semibold text-center text-[#2b6240]">👩‍🏫 학생 추가</h2>
                  <input
                    type="text"
                    className="border rounded-lg px-3 py-2 w-full"
                    placeholder="이름 입력"
                    value={newName}
                    onChange={(e) => setNewName(e.target.value)}
                  />
                  <select
                    className="border rounded-lg px-3 py-2 w-full"
                    value={newRisk}
                    onChange={(e) => setNewRisk(e.target.value)}
                  >
                    <option value="정상">정상</option>
                    <option value="주의">주의</option>
                    <option value="위험">위험</option>
                  </select>
                  <div className="flex justify-end gap-2">
                    <button
                      onClick={() => setShowAdd(false)}
                      className="px-3 py-2 rounded-lg border border-gray-300 text-gray-600"
                    >
                      취소
                    </button>
                    <button
                      onClick={addStudent}
                      className="px-3 py-2 rounded-lg bg-[#6BB7FF] text-white hover:bg-[#5aa7f0]"
                    >
                      추가
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      // 학생 상세 보기
      function StudentDetail({ student, onBack, onDelete }) {
        const { useState } = React;
        const [selectedDiary, setSelectedDiary] = useState(0);

        const diaries = Array.from({ length: 3 }, (_, i) => ({
          id: i,
          date: `2025-10-${String(10 + i).padStart(2, "0")}`,
          image: `https://picsum.photos/seed/${student.id}_${i}/400/250`,
          text:
            i === 1
              ? "오늘은 친구가 놀려서 속상했어요. 그래서 울었어요."
              : i === 2
              ? "오늘은 무서운 꿈을 꿨어요. 색칠을 진하게 했어요."
              : "오늘은 학교에서 즐거웠어요!",
          dangerWord: i === 1 ? 3 : 0,
          negColorRatio: i === 2 ? 45 : 10,
        }));

        const flagged = diaries.filter(
          (d) => d.dangerWord > 0 || d.negColorRatio > 30
        );

        return (
          <div className="space-y-5">
            {/* 상단 */}
            <div className="flex items-center gap-3">
              <button className="p-2 hover:bg-gray-100 rounded-lg" onClick={onBack}>
                ⬅ 뒤로
              </button>
              <h2 className="text-2xl font-semibold text-[#2b6240]">
                {student.name} 그림일기 분석
              </h2>
              <button
                onClick={onDelete}
                className="ml-auto text-red-500 text-sm hover:underline"
              >
                🗑 학생 삭제
              </button>
            </div>

            {/* 위험 일기 */}
            <div className="border rounded-2xl bg-white p-4 space-y-3">
              <div className="font-semibold text-[#8a3a3a]">
                ⚠️ 위험 감지 일기 ({flagged.length})
              </div>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {flagged.length > 0 ? (
                  flagged.map((d) => (
                    <div
                      key={d.id}
                      onClick={() => setSelectedDiary(d.id)}
                      className={`flex-shrink-0 w-32 border rounded-xl overflow-hidden cursor-pointer ${
                        selectedDiary === d.id
                          ? "ring-2 ring-[#F87171]"
                          : "hover:ring-2 hover:ring-[#FCA5A5]"
                      }`}
                    >
                      <img src={d.image} className="w-full h-24 object-cover" alt={`일기 ${d.date}`} />
                      <div className="p-1 text-xs text-center text-gray-600">
                        {d.date}
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="text-gray-400 text-sm">위험 일기가 없습니다.</div>
                )}
              </div>
            </div>

            {/* 선택된 일기 상세 */}
            <div className="border rounded-2xl bg-white p-4">
              <div className="font-semibold mb-3">선택된 일기 상세 보기</div>
              <div className="rounded-xl border overflow-hidden bg-white">
                <img
                  src={diaries[selectedDiary].image}
                  className="w-full object-cover max-h-[320px]"
                  alt="선택된 일기 이미지"
                />
                <div className="p-3 text-sm leading-relaxed">
                  {diaries[selectedDiary].text}
                </div>
                <div className="flex justify-around text-xs text-gray-600 border-t py-2 bg-gray-50">
                  <div>위험 단어: {diaries[selectedDiary].dangerWord}회</div>
                  <div>부정 색상: {diaries[selectedDiary].negColorRatio}%</div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
