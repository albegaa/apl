<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë§¤ì•„ë¦¬ ê·¸ë¦¼ì¼ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --header-h:60px;
      --nav-h:56px;
      /* âœ… ë¹„ìœ¨ë§Œ ë°”ê¾¸ë©´ í™ˆ/ì „ìš©í™”ë©´/ì¼ê¸°ì¥ ë™ì¼ì ìš© */
      --art-w: 4;  /* ê°€ë¡œ */
      --art-h: 3;  /* ì„¸ë¡œ */
      --paper:#fffdf8;
      --pencil:#222;
    }
    *{box-sizing:border-box}
    body { font-family: 'Pretendard', system-ui, -apple-system, sans-serif; background:#FAFAFA; color:#333; margin:0; }
    header { position: sticky; top:0; height:var(--header-h); background:rgba(255,255,255,.9); backdrop-filter: blur(8px);
      border-bottom: 2px solid #FFE08C; display:flex; justify-content:space-between; align-items:center; padding:12px 16px; z-index:2; }

    main { max-width: 540px; margin:auto; padding:16px; padding-bottom:calc(var(--nav-h) + 16px); }

    /* ===== ìŠ¤ì¼€ì¹˜ë¶ ê³µí†µ ===== */
    .sketchbook{
      position:relative;
      background: var(--paper);
      border: 2px solid var(--pencil);
      border-radius: 16px;
      padding: 14px 14px 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      /* ì¢…ì´ ì§ˆê° ì‚´ì§ */
      background-image:
        linear-gradient(transparent 0, transparent 28px, rgba(0,0,0,0.035) 28px, transparent 29px),
        radial-gradient(rgba(0,0,0,0.02) 1px, transparent 1px);
      background-size: 100% 29px, 6px 6px;
      background-position: 0 18px, 0 0;
    }
    .ring-strip{
      position:absolute; left:0; right:0; top:0;
      height:22px;
      border-bottom: 2px solid var(--pencil);
      background: linear-gradient(#ece8df, #f7f3ea);
      border-top-left-radius: 14px;
      border-top-right-radius: 14px;
      overflow:hidden;
    }
    .ring-strip .holes{
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 13px 50%, #333 6px, transparent 7px) 0 50%/ 52px 100% repeat-x;
      opacity:.2;
      mix-blend-mode: multiply;
    }

    /* ===== í™ˆ í™”ë©´ ë†’ì´ (ìˆ˜ì • ë²„ì „) ===== */

/* í™”ë©´ ì „ì²´ ë†’ì´ì— ë§ì¶° ì–µì§€ë¡œ ëŠ˜ë¦¬ì§€ ì•Šê³ ,
   ê·¸ëƒ¥ ë‚´ìš©ë§Œí¼ë§Œ ë†’ì´ë¥¼ ê°€ì§€ê²Œ ë³€ê²½ */
#screen-home {
  /* min-height: calc(100svh - var(--header-h)); */ /* â† ì‚­ì œ */
  display: block; /* flex -> block */
}

/* flexë¡œ ëŠ˜ì–´ë‚˜ë˜ ê±° ë§‰ê³ , ê·¸ëƒ¥ ë¸”ë¡ìœ¼ë¡œ */
#screen-home .sheet-wrap {
  /* flex:1;               â† ì‚­ì œ */
  /* display:flex;         â† ì‚­ì œ */
  width: 100%;
  max-width: 100%;
  display: block;
}

/* ìŠ¤ì¼€ì¹˜ë¶ ë°•ìŠ¤ê°€ í™”ë©´ ë†’ì´ì— ë§ì¶° ì»¤ì§€ë˜ ê±° ì œê±° */
#homeSheet {
  /* min-height: calc(100svh - var(--header-h) - 32px); */ /* â† ì‚­ì œ */
  display: flex;
  flex-direction: column;
}


    .row { display:flex; align-items:center; gap:10px; margin:10px 0 6px; }
    .row .label { min-width:52px; font-weight:700; color:#2b2b2b; }
    .row .value { font-weight:700; color:#333; }
    .row input[type="text"],
    .row input[type="date"] {
      flex:1; padding:10px 12px; border:2px solid var(--pencil); border-radius:12px; font-size:15px;
      background: #fffef9;
    }

    /* ë‚ ì”¨ ë²„íŠ¼ë§Œ (ë°•ìŠ¤ ì œê±°) */
    .weather-wrap{ display:flex; align-items:center; gap:8px; margin-left:auto; }
    .weather-label { font-weight:700; margin-right:2px; color:#2b2b2b; }
    /* ì´ëª¨ì§€ ê°€ìš´ë° ì •ë ¬ */
    .weather-btn{
      position: relative;
      width:38px; height:38px;
      border-radius:10px;
      border:2px dashed #b6b6b6;
      background:#fff;
      cursor:pointer;
      font-size:0; line-height:0; padding:0;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .weather-btn::after{
      content: attr(data-w);
      position:absolute; left:50%; top:50%;
      transform: translate(-50%, -50%);
      font-size:20px; line-height:1;
      font-family: 'Apple Color Emoji','Segoe UI Emoji','Noto Color Emoji',sans-serif;
    }
    .weather-btn:hover{ transform: translateY(-1px); box-shadow:0 1px 0 #eee; }
    .weather-btn.active { border-color:#FFB800; box-shadow:0 0 0 3px #FFE08C; }
    .weather-wrap.readonly .weather-btn{ pointer-events:none; opacity:.75; }

    .dash { height:0; border:none; border-top:4px dashed #888; margin:10px 0 12px; opacity:.6; }

    /* ===== ê·¸ë¦¼ í”„ë ˆì„(ìŠ¤ì¼€ì¹˜ë¶ ìº”ë²„ìŠ¤) ===== */
    .sketch-artframe{
      width:100%;
      aspect-ratio: var(--art-w) / var(--art-h);
      border-radius:12px;
      border:2px solid var(--pencil);
      background:#fffef9;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.06);
      display:grid; place-items:center; overflow:hidden;
    }
    .sketch-artframe img{ width:100%; height:100%; object-fit:contain; display:block; }

    /* í¸ì§‘ëª¨ë“œ ì¸ë„¤ì¼(í”„ë ˆì„ ë‚´ë¶€ ì ì„ ) */
    .thumb-inner{
      width:100%;
      aspect-ratio: var(--art-w) / var(--art-h);
      border-radius:10px; border:2px dashed #aaa;
      display:grid; place-items:center; background:#fffef9; cursor:pointer;
    }
    .thumb-inner:hover{ border-color:#6BB7FF; }
    .thumb-inner img{ width:100%; height:100%; object-fit:contain; border-radius:8px; }

    /* ì¤„ ê³µì±… ëŠë‚Œ í…ìŠ¤íŠ¸ ë°•ìŠ¤ */
    .lined-box { border:2px solid var(--pencil); border-radius:14px; padding:10px; background:#fffef9; }
    .lined-textarea {
      width:100%; min-height:160px; border:none; outline:none; resize:none; padding:10px 12px; font-size:16px; line-height:32px;
      background-image:repeating-linear-gradient(#bfbfbf3a 0 1px, transparent 1px 32px);
      background-size:100% 32px; background-position:0 26px; border-radius:8px;
    }

    .btn { border:none; border-radius:16px; padding:10px 14px; cursor:pointer; font-size:15px; }
    .btn-outline { background:#fff; border:2px solid var(--pencil); }
    .btn-yellow { background:#FFE08C; color:#333; border:2px solid #d3a700; }
    .btn-danger { background:#F28482; color:#fff; border:2px solid #c96c6a; }
    .btn-primary { background:#6BB7FF; color:#fff; border:2px solid #4f9fe9; }

    nav { position:fixed; bottom:0; left:0; right:0; height:var(--nav-h); display:flex; border-top:2px solid #FFE08C; background:#fff; z-index:2; }
    nav button { flex:1; padding:12px 0; background:none; border:none; font-size:14px; color:gray; cursor:pointer; }
    nav button.active { color:#6BB7FF; font-weight:bold; }

    .teacher-section { background:#F7FBFF; border:2px dashed #6BB7FF; border-radius:12px; padding:12px; margin-top:10px; }
    .stamp-overlay { position:absolute; top:6px; right:6px; width:56px; height:56px; opacity:.95; pointer-events:none; }
    .stamp-big { width:120px; height:120px; display:inline-block; opacity:.95; margin:6px 0 8px; transform: rotate(-6deg); }

    /* ===== ë‚´ ì¼ê¸°ì¥: í´ë¼ë¡œì´ë“œ ì¹´ë“œ ===== */
    .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    .grid .item { position:relative; cursor:pointer; transform: rotate(-0.2deg); transition: transform .18s ease, box-shadow .18s ease; }
    .grid .item:hover { transform: rotate(0deg) translateY(-2px); }
    .polaroid{
      position:relative;           /* âœ… ë„ì¥ ì˜¤ë²„ë ˆì´ ê¸°ì¤€ */
      background:#fffef9;
      border: 2px solid var(--pencil);
      border-radius: 14px;
      padding: 8px 8px 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,.06);
    }
    .polaroid .photo{
      width:100%;
      aspect-ratio: var(--art-w) / var(--art-h);
      border-radius:8px;
      border:1px solid #d8d2c7;
      background:#fff; display:grid; place-items:center; overflow:hidden;
    }
    .polaroid .photo img{ width:100%; height:100%; object-fit:contain; display:block; }
    .tape{
      position:absolute; left:50%; top:-8px; transform: translateX(-50%) rotate(-3deg);
      width:60px; height:16px; background: repeating-linear-gradient(45deg, #f3e1a1, #f3e1a1 6px, #f5e7b8 6px, #f5e7b8 12px);
      opacity:.9; border:1px solid rgba(0,0,0,.08); border-radius:2px; box-shadow: 0 2px 3px rgba(0,0,0,.08);
      pointer-events:none;
    }
    .pol-title{ font-weight:700; margin-top:6px; }
    .pol-sub{ font-size:11px; color:#646464; }

    .back-btn { background:#F9B4AB; color:#fff; padding:8px 12px; border:none; border-radius:12px; cursor:pointer; margin-bottom:10px; }

    /* ===== ê·¸ë¦¼ ì „ìš© í™”ë©´ ===== */
    #screen-drawonly { min-height:calc(100svh - var(--header-h)); display:flex; }
    .draw-pane{ flex:1; background:var(--paper); border-radius:18px; padding:12px; border:2px solid var(--pencil); display:flex; flex-direction:column; gap:10px; }
    .palette { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    .color-btn { width:28px; height:28px; border-radius:50%; border:2px solid #fff; cursor:pointer; box-shadow:0 0 2px rgba(0,0,0,.2); }
    .canvas-box {
      width:100%;
      aspect-ratio: var(--art-w) / var(--art-h);
      border:2px dashed #bbb; border-radius:12px; overflow:hidden; background:#fffef9;
    }
    canvas { width:100%; height:100%; display:block; background:#fff; }

    /* í™ˆí™”ë©´ ì•¡ì…˜ ì˜ì—­: ì˜¤ë¥¸ìª½ ì •ë ¬ */
.home-actions{
  display:flex;
  justify-content:flex-end;
  gap:8px;
  margin-top:12px;
}


  </style>
  
</head>
<body>
  <header>
    <div class="logo" style="display:flex;align-items:center;gap:10px;">
      <img src="logo.png" alt="ë§¤ì•„ë¦¬ ë¡œê³ " style="height:36px;border-radius:8px;">
      <div>
        <div style="color:#6BB7FF;font-weight:700;">ë§¤ì•„ë¦¬</div>
        <div style="color:#7DCFB6;font-size:12px;">ë§¤ì¼ ì•„ì´ ì´í•´í•˜ê¸°</div>
      </div>
    </div>
    <div>ğŸŒ¤ï¸</div>
  </header>

  <!-- âœ… í™ˆ (ì˜¤ëŠ˜ ì¼ê¸°: ì½ê¸° or í¼) -->
  <main id="screen-home">
    <div class="sheet-wrap" style="width:100%;">
      <!-- ì²˜ìŒì—” ë Œë” ì™„ë£Œ ì „ê¹Œì§€ ìˆ¨ê¹€ â†’ ë ˆì´ì•„ì›ƒ í”ë“¤ë¦¼ ë°©ì§€ -->
      <div class="sketchbook sheet" id="homeSheet" style="display:none">
        <div class="ring-strip"><div class="holes"></div></div>

        <!-- ìƒë‹¨: ë‚ ì§œ + ë‚ ì”¨ -->
        <div class="row" style="justify-content:space-between; margin-top:28px;">
          <div class="row" style="flex:1;">
            <div class="label">ë‚ ì§œ :</div>
            <!-- âœ¨ ê³ ì • í‘œì‹œ ëŒ€ì‹  ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥í•œ date ì…ë ¥ -->
            <input type="date" id="diaryDate" />
          </div>
          <div class="weather-wrap">
            <div class="weather-label">ë‚ ì”¨ :</div>
            <button class="weather-btn" data-w="â˜€ï¸" onclick="selectWeather(this)">â˜€ï¸</button>
            <button class="weather-btn" data-w="â˜ï¸" onclick="selectWeather(this)">â˜ï¸</button>
            <button class="weather-btn" data-w="â„ï¸" onclick="selectWeather(this)">â„ï¸</button>
            <button class="weather-btn" data-w="ğŸŒ§ï¸" onclick="selectWeather(this)">ğŸŒ§ï¸</button>
          </div>
        </div>

        <hr class="dash" />

        <!-- ì œëª© -->
        <div class="row" id="titleRow">
          <div class="label">ì œëª©</div>
          <input type="text" id="diaryTitle" placeholder="ì˜¤ëŠ˜ ê·¸ë¦¼ì¼ê¸°ì˜ ì œëª©" />
        </div>

        <!-- ê·¸ë¦¼ ì¸ë„¤ì¼(ëˆŒëŸ¬ì„œ ì „ìš© í™”ë©´) -->
        <div id="thumbBox" style="margin-top:10px;">
          <div id="drawThumb" class="thumb-inner" onclick="openDrawScreen()">
            <div style="text-align:center; color:#888;">
              <div style="font-size:22px; margin-bottom:6px;">ğŸ–ï¸ ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ ê·¸ë¦¼ ê·¸ë¦¬ê¸°</div>
              <div style="font-size:13px;">ê·¸ë¦¼ ì „ìš© í™”ë©´ìœ¼ë¡œ ì´ë™í•´ìš”</div>
            </div>
          </div>
        </div>

        <!-- ë‚´ìš© -->
        <div class="lined-box" id="textBox" style="margin-top:12px; flex:1;">
          <textarea id="diaryText" class="lined-textarea" placeholder="ì˜¤ëŠ˜ì˜ ì´ì•¼ê¸°ë¥¼ ì¨ ë³´ì„¸ìš”."></textarea>
        </div>

        <!-- ë²„íŠ¼ -->
        <div id="homeButtons" class="home-actions">
  <button class="btn btn-yellow" onclick="uploadDrawing()">ì™„ì„±!</button>
</div>


        <input type="hidden" id="weatherText" />
      </div>
    </div>
  </main>

  <!-- âœ… ê·¸ë¦¼ ì „ìš© í™”ë©´ -->
  <main id="screen-drawonly" style="display:none;">
    <div class="draw-pane">
      <div class="palette">
        <div class="color-btn" style="background:black;" onclick="setColor('black')"></div>
        <div class="color-btn" style="background:red;" onclick="setColor('red')"></div>
        <div class="color-btn" style="background:blue;" onclick="setColor('blue')"></div>
        <div class="color-btn" style="background:green;" onclick="setColor('green')"></div>
        <div class="color-btn" style="background:pink;" onclick="setColor('pink')"></div>
        <div class="color-btn" style="background:orange;" onclick="setColor('orange')"></div>
        <button class="btn btn-outline" onclick="toggleEraser()">ğŸ§½ ì§€ìš°ê°œ</button>
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
          <span style="font-size:13px;color:#666;">ë¶“ ë‘ê»˜</span>
          <input type="range" id="brushSize" min="2" max="22" value="6" />
        </div>
      </div>
      <div class="canvas-box">
        <canvas id="drawCanvas"></canvas>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn btn-outline" onclick="closeDrawScreen(false)">ì·¨ì†Œ</button>
        <button class="btn btn-yellow" onclick="closeDrawScreen(true)">ê·¸ë¦¼ ì ìš©</button>
      </div>
    </div>
  </main>

  <!-- âœ… ë‚´ ì¼ê¸°ì¥ (ìŠ¤ì¼€ì¹˜ë¶ ì¹´ë“œ ê·¸ë¦¬ë“œ) -->
  <main id="screen-journal" style="display:none;">
    <div class="sketchbook sheet">
      <div class="ring-strip"><div class="holes"></div></div>
      <h2 style="margin:28px 0 10px 2px; font-size:18px;">ë‚´ ì¼ê¸°ì¥</h2>
      <div class="grid" id="todayGrid"></div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap; justify-content:flex-end;">
        <button class="btn btn-yellow" onclick="switchTab('home')">ğŸ–ï¸ ê·¸ë¦¼ì¼ê¸° ì“°ê¸°</button>
      </div>
    </div>
  </main>

  <!-- ì¼ê¸° ë³´ê¸° (ìŠ¤ì¼€ì¹˜ë¶) -->
  <main id="screen-view" style="display:none;">
    <div class="sketchbook sheet">
      <div class="ring-strip"><div class="holes"></div></div>
      <div id="viewCard" style="margin-top:28px;"></div>
      <button class="back-btn" onclick="switchTab('journal')">â† ë‚´ ì¼ê¸°ì¥ìœ¼ë¡œ</button>
    </div>
  </main>

  <!-- ë‚´ í”„ë¡œí•„ (ë³´ê¸°/ìˆ˜ì • í†µí•©) -->
  <main id="screen-profile" style="display:none;">
    <div class="sketchbook sheet">
      <div class="ring-strip"><div class="holes"></div></div>
      <h2 style="margin:28px 0 10px 2px; font-size:18px;">ë‚´ í”„ë¡œí•„</h2>

      <div id="profileView" style="display:none;">
        <p><strong>ì´ë¦„:</strong> <span id="viewName"></span></p>
        <p><strong>í•™êµ:</strong> <span id="viewSchool"></span></p>
        <p><strong>í•™ë…„/ë°˜:</strong> <span id="viewGrade"></span> <span id="viewClass"></span></p>
        <p><strong>ì†Œê°œ:</strong> <span id="viewIntro"></span></p>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
          <button class="btn btn-yellow" onclick="enterProfileEdit()">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
        </div>
      </div>

      <form id="profileForm" onsubmit="event.preventDefault(); saveProfile();">
        <label>ì´ë¦„</label>
        <input id="myName" placeholder="ì´ë¦„ ì…ë ¥" />

        <label>í•™êµ</label>
        <input id="mySchool" placeholder="ì˜ˆ: ë§¤ì•„ë¦¬ì´ˆë“±í•™êµ" />

        <div style="display:flex; gap:8px;">
          <div style="flex:1;">
            <label>í•™ë…„</label>
            <select id="myGrade">
              <option value="">ì„ íƒ</option>
              <option>1í•™ë…„</option><option>2í•™ë…„</option><option>3í•™ë…„</option>
              <option>4í•™ë…„</option><option>5í•™ë…„</option><option>6í•™ë…„</option>
            </select>
          </div>
          <div style="flex:1;">
            <label>ë°˜</label>
            <select id="myClass">
              <option value="">ì„ íƒ</option>
              <option>1ë°˜</option><option>2ë°˜</option><option>3ë°˜</option>
              <option>4ë°˜</option><option>5ë°˜</option>
            </select>
          </div>
        </div>

        <label>ìê¸°ì†Œê°œ</label>
        <textarea id="myIntro" placeholder="ë‚˜ë¥¼ ì†Œê°œí•´ìš”!"></textarea>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
          <button type="button" class="btn btn-outline" onclick="cancelProfileEdit()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
      </form>
    </div>
  </main>

  <nav>
    <button id="tab-home" class="active" onclick="switchTab('home')">ğŸ  í™ˆ</button>
    <button id="tab-journal" onclick="switchTab('journal')">ğŸ“’ ë‚´ ì¼ê¸°ì¥</button>
    <button id="tab-profile" onclick="switchTab('profile')">ğŸ‘¤ ë‚´ í”„ë¡œí•„</button>
  </nav>

<script>
  // ===== ìƒìˆ˜/ìƒíƒœ =====
  const STAMP_SRC = 'stamp.png';
  let tempImageData = null;
  let draftSaveTimer = null;

  // ìš”ì†Œ
  const homeSheet = document.getElementById('homeSheet');
  const drawThumb = document.getElementById('drawThumb');
  const todayGrid = document.getElementById('todayGrid');
  const viewCard = document.getElementById('viewCard');

  const diaryText = document.getElementById('diaryText');
  const diaryDate = document.getElementById('diaryDate'); // âœ¨ ì´ì œ ë³´ì´ëŠ” date input
  const weatherText = document.getElementById('weatherText');
  const diaryTitle = document.getElementById('diaryTitle');

  // ì „ìš© ìº”ë²„ìŠ¤
  const canvas = document.getElementById('drawCanvas');
  const ctx = canvas.getContext('2d');
  const brushSize = document.getElementById('brushSize');

  let drawing = false, currentColor = 'black', eraserMode = false;
  let lastX = 0, lastY = 0;
  let editDiary = null;     // ì¼ê¸° ìˆ˜ì • ì¤‘(ê¸°ì¡´ í•­ëª©)
  let drawings = [];        // ë‚´ ì¼ê¸° ëª©ë¡ ìºì‹œ

  // ===== ìœ í‹¸ =====
  function todayStr(){ return new Date().toISOString().split('T')[0]; }
  function formatKoreanDate(iso){
    if(!iso) return '';
    const d = new Date(iso);
    if (isNaN(d)) return iso;
    return `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼`;
  }
  function setWeatherActive(weather, readonly=false){
    const wrap = document.querySelector('.weather-wrap');
    document.querySelectorAll('.weather-btn').forEach(b=>{
      b.classList.toggle('active', b.dataset.w === (weather || ''));
    });
    if (wrap) wrap.classList.toggle('readonly', !!readonly);
  }

  // ì €ì¥ì†Œ
  function loadAllDiaries(){ try { return JSON.parse(localStorage.getItem('maeariDiaries')) || []; } catch{ return []; } }
  function saveAllDiaries(arr){ localStorage.setItem('maeariDiaries', JSON.stringify(arr)); }
  function getMyName(){
    const saved = localStorage.getItem('maeariProfile'); if(!saved) return 'ì´ë¦„ë¯¸ì •';
    try { return JSON.parse(saved).name || 'ì´ë¦„ë¯¸ì •'; } catch { return 'ì´ë¦„ë¯¸ì •'; }
  }
  function loadMyDrawings(){ drawings = loadAllDiaries().filter(d => d.studentName === getMyName()); }
  function findDiaryByDate(studentName, date){
    return loadAllDiaries().find(d => d.studentName===studentName && d.date===date) || null;
  }
  function upsertMyDiary(entry){
    const all = loadAllDiaries();
    const idx = all.findIndex(d => d.studentName===entry.studentName && d.date===entry.date);
    if (idx>=0) all[idx] = entry; else all.push(entry);
    saveAllDiaries(all); loadMyDrawings();
  }

  // ---- Draft(ì‘ì„±ì¤‘) ê´€ë¦¬ ----
  function draftKey(studentName, date){ return `maeariDraft:${studentName}:${date}`; }
  function saveDraft(){
    clearTimeout(draftSaveTimer);
    draftSaveTimer = setTimeout(()=>{
      const key = draftKey(getMyName(), diaryDate.value || todayStr());
      const draft = {
        studentName: getMyName(),
        date: diaryDate.value || todayStr(),
        title: diaryTitle.value || "",
        weather: weatherText.value || "",
        text: diaryText.value || "",
        imageData: tempImageData || ""
      };
      localStorage.setItem(key, JSON.stringify(draft));
    }, 200);
  }
  function loadDraft(studentName, date){
    const key = draftKey(studentName, date);
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }
  function clearDraft(studentName, date){
    localStorage.removeItem(draftKey(studentName, date));
  }

  // âœ… ë‚ ì§œ ë³€ê²½ì‹œ ë·° ê°±ì‹ 
  function onDateChange(){
    const d = diaryDate.value || todayStr();
    tempImageData = null;  // ì„ì‹œ ì´ë¯¸ì§€ ì´ˆê¸°í™” (ë‹¤ë¥¸ ë‚ ì§œë¡œ ì „í™˜ ì‹œ ì¶©ëŒ ë°©ì§€)
    editDiary = null;
    renderHome(d);
    updateThumb();
  }

  // ì´ˆê¸°í™”
  window.addEventListener('load', () => {
    const t = todayStr();
    diaryDate.value = t;             // ì…ë ¥ ê°€ëŠ¥í•œ ë‚ ì§œ ê¸°ë³¸ê°’ = ì˜¤ëŠ˜

    loadProfile();
    loadMyDrawings();
    renderHome(t);       // âœ… ì„ íƒ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë·°/í¼ ê²°ì •
    renderGrid();
    updateThumb();

    diaryTitle.addEventListener('input', saveDraft);
    diaryText.addEventListener('input', saveDraft);
    diaryDate.addEventListener('change', onDateChange); // âœ¨ ë‚ ì§œ ì§ì ‘ ë³€ê²½ í•¸ë“¤ë§

    // âœ… ì´ˆê¸° ë Œë” ëë‚œ ë’¤ í•œ ë²ˆì— í‘œì‹œ â†’ ë ˆì´ì•„ì›ƒ í”ë“¤ë¦¼ ë°©ì§€
    document.getElementById('homeSheet').style.display = 'block';
  });

  // í™ˆ ë Œë”ë§ (ì„ íƒ ë‚ ì§œ ìƒíƒœ ê¸°ë°˜)
  function renderHome(selectedDate){
    const student = getMyName();
    const t = selectedDate || diaryDate.value || todayStr();
    diaryDate.value = t; // ì…ë ¥ê°’ ë³´ì •

    const final = findDiaryByDate(student, t);
    if (final){
      renderTodayReadOnly(final);
      setWeatherActive(final.weather, true);
      return;
    }
    const draft = loadDraft(student, t);
    renderTodayForm(draft || null);
  }

  // í™ˆ: ì½ê¸° ì „ìš© ì¹´ë“œ
  function renderTodayReadOnly(entry){
    // í¼ ìˆ¨ê¹€
    document.getElementById('titleRow').style.display = 'none';
    document.getElementById('thumbBox').style.display = 'none';
    document.getElementById('textBox').style.display = 'none';
    document.getElementById('homeButtons').style.display = 'none';

    // ì¹´ë“œ ì˜ì—­
    let ro = document.getElementById('todayRO');
    if (!ro){ ro = document.createElement('div'); ro.id='todayRO'; ro.className='lined-box'; ro.style.marginTop='10px'; homeSheet.appendChild(ro); }
    const imageBlock = entry.imageData
      ? `<div class="sketch-artframe"><img src="${entry.imageData}" alt="ê·¸ë¦¼ ë¯¸ë¦¬ë³´ê¸°"></div>`
      : `<div class="sketch-artframe" style="color:#888;font-size:13px;">(ê·¸ë¦¼ ì—†ìŒ)</div>`;

    ro.innerHTML = `
      <h2 style="margin:0 0 6px 2px; font-size:18px;">ì˜¤ëŠ˜ì˜ ì¼ê¸°</h2>
      <div style="color:gray;font-size:13px;margin-bottom:6px;">${formatKoreanDate(entry.date)} / ${entry.weather || ''}</div>
      ${entry.stamp ? `<img src="${STAMP_SRC}" alt="ì°¸ ì˜í–ˆì–´ìš” ë„ì¥" class="stamp-big">` : ``}
      ${imageBlock}
      <div style="font-weight:700; margin:8px 0;">${entry.title || 'ì œëª© ì—†ìŒ'}</div>
      <p style="font-size:15px;white-space:pre-wrap;margin:0;">${entry.text || ''}</p>
      ${
        (entry.teacherComment && entry.teacherComment.trim()) ?
        `<div class="teacher-section" style="margin-top:10px;">
           <div style="font-weight:700;color:#1d5aa6;margin-bottom:6px;">ğŸ“ ì„ ìƒë‹˜ ì½”ë©˜íŠ¸</div>
           <div style="white-space:pre-wrap;">${entry.teacherComment}</div>
         </div>` : ``
      }
      <div style="display:flex;gap:8px;justify-content:flex-end; margin-top:12px;">
        <button class="btn btn-yellow" onclick="editToday('${entry.date}')">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
      </div>
    `;
  }

  // í™ˆ: ì‘ì„± í¼ í‘œì‹œ(ì´ˆê¸°/ì„ì‹œë³µì›)
  function renderTodayForm(draft){
    document.getElementById('titleRow').style.display = '';
    document.getElementById('thumbBox').style.display = '';
    document.getElementById('textBox').style.display = '';
    document.getElementById('homeButtons').style.display = '';
    const ro = document.getElementById('todayRO'); if (ro) ro.remove();

    diaryTitle.value = draft?.title || '';
    diaryText.value = draft?.text || '';
    weatherText.value = draft?.weather || '';
    setWeatherActive(weatherText.value, false);
    tempImageData = draft?.imageData || null;
    updateThumb();
  }

  function editToday(date){
    const entry = findDiaryByDate(getMyName(), date);
    if (!entry) return;
    const draft = { ...entry };
    localStorage.setItem(draftKey(getMyName(), date), JSON.stringify(draft));
    diaryDate.value = date; // âœ¨ ìˆ˜ì •í•˜ë ¤ëŠ” ë‚ ì§œë¡œ ì…ë ¥ê°’ ë™ê¸°í™”
    renderTodayForm(draft);
  }

  // ë‚ ì”¨
  function selectWeather(btn){
    document.querySelectorAll('.weather-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    weatherText.value = btn.dataset.w;
    saveDraft();
  }

  // íƒ­
  function switchTab(tab){
    document.querySelectorAll('main').forEach(m => m.style.display='none');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(`screen-${tab}`).style.display='block';
    const tabBtn = document.getElementById(`tab-${tab}`); if (tabBtn) tabBtn.classList.add('active');

    if (tab === 'home') renderHome(diaryDate.value || todayStr());
    if (tab === 'journal') renderGrid();
    if (tab === 'profile') loadProfile();
  }

  // í™ˆ â†’ ì „ìš©í™”ë©´
  function openDrawScreen(){
    requestAnimationFrame(setCanvasSize);
    if (tempImageData){
      const img = new Image(); img.onload=()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); }; img.src=tempImageData;
    } else if (editDiary?.imageData){
      const img = new Image(); img.onload=()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); }; img.src=editDiary.imageData;
    } else { ctx.clearRect(0,0,canvas.width,canvas.height); }
    document.getElementById('screen-home').style.display='none';
    document.getElementById('screen-drawonly').style.display='block';
  }

  // ì „ìš©í™”ë©´ ë‹«ê¸°
  function closeDrawScreen(apply){
    if (apply){
      tempImageData = canvas.toDataURL();
      updateThumb();
      saveDraft();
    }
    document.getElementById('screen-drawonly').style.display='none';
    document.getElementById('screen-home').style.display='block';
  }

  // ì¸ë„¤ì¼ ê°±ì‹ 
  function updateThumb(){
    if (tempImageData){
      drawThumb.innerHTML = `<div class="sketch-artframe"><img src="${tempImageData}" alt="ê·¸ë¦¼ ë¯¸ë¦¬ë³´ê¸°"></div>`;
    }else{
      drawThumb.innerHTML = `
        <div style="text-align:center; color:#888;">
          <div style="font-size:22px; margin-bottom:6px;">ğŸ–ï¸ ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ ê·¸ë¦¼ ê·¸ë¦¬ê¸°</div>
          <div style="font-size:13px;">ê·¸ë¦¼ ì „ìš© í™”ë©´ìœ¼ë¡œ ì´ë™í•´ìš”</div>
        </div>`;
    }
  }

  // ì €ì¥(ìµœì¢…)
  function uploadDrawing(){
    const imageData = tempImageData || '';
    const text = diaryText.value.trim() || "ë¬´ì œ";
    const date = diaryDate.value || todayStr();
    const weather = weatherText.value.trim();
    const title = diaryTitle.value.trim() || "ì œëª© ì—†ìŒ";
    const studentName = getMyName();

    const entry = { studentName, date, title, weather, text, imageData,
      stamp: editDiary?.stamp || false,
      teacherComment: editDiary?.teacherComment || "" };

    upsertMyDiary(entry);

    clearDraft(studentName, date);
    diaryText.value=""; diaryTitle.value="";
    tempImageData=null; updateThumb();
    document.querySelectorAll('.weather-btn').forEach(b=>b.classList.remove('active'));

    renderHome(date);
    renderGrid();
    switchTab('home');
  }

  // ì¼ê¸°ì¥ (í´ë¼ë¡œì´ë“œ ì¹´ë“œ)
  function renderGrid(){
    todayGrid.innerHTML = "";
    drawings.sort((a,b)=> (a.date < b.date ? 1 : -1));
    drawings.forEach(diary => {
      const div = document.createElement('div');
      div.className = 'item';

      const photo = diary.imageData
        ? `<div class="photo"><img src="${diary.imageData}" alt="ê·¸ë¦¼ ë¯¸ë¦¬ë³´ê¸°"></div>`
        : `<div class="photo" style="color:#888;font-size:12px;">(ê·¸ë¦¼ ì—†ìŒ)</div>`;

      div.innerHTML = `
        <div class="tape"></div>
        <div class="polaroid">
          ${photo}
          ${diary.stamp ? `<img src="${STAMP_SRC}" alt="ì°¸ ì˜í–ˆì–´ìš”" class="stamp-overlay">` : ''}
          <div class="pol-title">${diary.title || 'ì œëª© ì—†ìŒ'}</div>
          <div class="pol-sub">${formatKoreanDate(diary.date)} / ${diary.weather || ''}</div>
        </div>`;
      div.onclick = () => openDiary(diary);
      todayGrid.appendChild(div);
    });
  }

  // ìƒì„¸(ìŠ¤ì¼€ì¹˜ë¶)
  function openDiary(diary){
    switchTab('view');
    const fresh = loadAllDiaries().find(d => d.studentName===diary.studentName && d.date===diary.date) || diary;
    const imageBlock = fresh.imageData
      ? `<div class="sketch-artframe"><img src="${fresh.imageData}" alt="ê·¸ë¦¼ ë¯¸ë¦¬ë³´ê¸°"></div>`
      : `<div class="sketch-artframe" style="color:#888;font-size:13px;">(ê·¸ë¦¼ ì—†ìŒ)</div>`;

    viewCard.innerHTML = `
      <h2 style="margin:28px 0 8px 2px;">${fresh.title || 'ì œëª© ì—†ìŒ'}</h2>
      <div style="color:gray;font-size:13px;margin-bottom:6px;">${formatKoreanDate(fresh.date)} / ${fresh.weather || ''}</div>
      ${fresh.stamp ? `<img src="${STAMP_SRC}" alt="ì°¸ ì˜í–ˆì–´ìš” ë„ì¥" class="stamp-big">` : ``}
      ${imageBlock}
      <p style="font-size:15px;white-space:pre-wrap; margin-top:8px;">${fresh.text}</p>
      ${
        (fresh.teacherComment && fresh.teacherComment.trim()) ?
        `<div class="teacher-section">
           <div style="font-weight:700;color:#1d5aa6;margin-bottom:6px;">ğŸ“ ì„ ìƒë‹˜ ì½”ë©˜íŠ¸</div>
           <div style="white-space:pre-wrap;">${fresh.teacherComment}</div>
         </div>` : ``
      }
      <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:12px;">
        <button class="btn btn-danger" onclick="deleteDiary('${fresh.date}')">ğŸ—‘ï¸ ì‚­ì œ</button>
      </div>
    `;
  }

  function deleteDiary(date){
    if (!confirm("ì •ë§ ì´ ê·¸ë¦¼ì¼ê¸°ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
    const all = loadAllDiaries().filter(d => !(d.studentName===getMyName() && d.date===date));
    saveAllDiaries(all); loadMyDrawings(); renderGrid(); alert("ê·¸ë¦¼ì¼ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ—‘ï¸"); switchTab('journal');
  }

  function editExistingDiary(date){
    const diary = drawings.find(d => d.date === date); if (!diary) return;
    editDiary = diary;
    const draft = { ...diary };
    localStorage.setItem(draftKey(getMyName(), date), JSON.stringify(draft));
    switchTab('home');
  }

  // ğŸ¨ ìº”ë²„ìŠ¤
  function setCanvasSize(){
    const box = canvas.parentElement.getBoundingClientRect();
    const ratio = getAspect();
    const width = Math.floor(box.width);
    const height = Math.floor(width * ratio);
    canvas.width = width;
    canvas.height = height;
    ctx.lineCap = "round"; ctx.lineJoin = "round";
  }
  function getAspect(){
    const styles = getComputedStyle(document.documentElement);
    const w = parseFloat(styles.getPropertyValue('--art-w')) || 4;
    const h = parseFloat(styles.getPropertyValue('--art-h')) || 3;
    return h / w;
  }
  function getPos(e){
    const r = canvas.getBoundingClientRect();
    if (e.touches && e.touches.length>0) return [e.touches[0].clientX - r.left, e.touches[0].clientY - r.top];
    return [e.clientX - r.left, e.clientY - r.top];
  }
  function startDraw(e){ drawing = true; const [x,y]=getPos(e); [lastX,lastY]=[x,y]; }
  function draw(e){
    if(!drawing) return;
    e.preventDefault();
    const [x,y]=getPos(e);
    ctx.strokeStyle = eraserMode ? "#fff" : currentColor;
    ctx.lineWidth = brushSize.value;
    ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.stroke();
    [lastX,lastY]=[x,y];
  }
  function stopDraw(){ drawing=false; }

  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDraw);
  canvas.addEventListener('mouseout', stopDraw);
  canvas.addEventListener('touchstart', startDraw);
  canvas.addEventListener('touchmove', draw, {passive:false});
  canvas.addEventListener('touchend', stopDraw);

  function setColor(c){
    currentColor = c; eraserMode = false;
    document.querySelectorAll('.color-btn').forEach(b=>{ b.style.outline=''; b.style.boxShadow=''; });
    const selected = Array.from(document.querySelectorAll('.color-btn')).find(btn => btn.style.background === c);
    if (selected){ selected.style.outline='3px solid #FFE08C'; selected.style.boxShadow='0 0 6px #FFE08C'; }
    const eraserBtn = document.querySelector('.btn.btn-outline');
    if (eraserBtn){ eraserBtn.style.background=''; eraserBtn.style.color=''; eraserBtn.style.border='2px solid var(--pencil)'; }
  }
  function toggleEraser(){
    eraserMode = !eraserMode;
    const eraserBtn = document.querySelector('.btn.btn-outline');
    if (eraserMode){ eraserBtn.style.background='#FFE08C'; eraserBtn.style.color='#333'; eraserBtn.style.border='2px solid #E1B000'; }
    else { eraserBtn.style.background=''; eraserBtn.style.color=''; eraserBtn.style.border='2px solid var(--pencil)'; }
    document.querySelectorAll('.color-btn').forEach(b=>{ b.style.outline=''; b.style.boxShadow=''; });
  }

  // ---- í”„ë¡œí•„ (ë³´ê¸°/ìˆ˜ì • í† ê¸€) ----
  function loadProfile() {
    const saved = localStorage.getItem('maeariProfile');
    if (!saved) {
      document.getElementById('profileView').style.display = 'none';
      document.getElementById('profileForm').style.display = 'block';
      myName.value = ''; mySchool.value = '';
      myGrade.value = ''; myClass.value = ''; myIntro.value = '';
      return;
    }
    const p = JSON.parse(saved);
    showProfileView(p);
    myName.value = p.name || '';
    mySchool.value = p.school || '';
    myGrade.value = p.grade || '';
    myClass.value = p.classNum || '';
    myIntro.value = p.intro || '';
  }

  function showProfileView(p) {
    document.getElementById('profileForm').style.display = 'none';
    document.getElementById('profileView').style.display = 'block';
    document.getElementById('viewName').innerText = p.name || '';
    document.getElementById('viewSchool').innerText = p.school || '';
    document.getElementById('viewGrade').innerText = p.grade || '';
    document.getElementById('viewClass').innerText = p.classNum || '';
    document.getElementById('viewIntro').innerText = p.intro || '';
  }

  function enterProfileEdit() {
    document.getElementById('profileView').style.display = 'none';
    document.getElementById('profileForm').style.display = 'block';
  }

  function cancelProfileEdit() {
    const saved = localStorage.getItem('maeariProfile');
    if (saved) {
      showProfileView(JSON.parse(saved));
    } else {
      document.getElementById('profileView').style.display = 'none';
      document.getElementById('profileForm').style.display = 'block';
    }
  }

  function saveProfile() {
    const profile = {
      name: myName.value.trim(),
      school: mySchool.value.trim(),
      grade: myGrade.value,
      classNum: myClass.value,
      intro: myIntro.value.trim()
    };
    if (!profile.name) {
      alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      myName.focus();
      return;
    }
    localStorage.setItem('maeariProfile', JSON.stringify(profile));
    alert('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ âœ…');
    showProfileView(profile);
    renderHome(diaryDate.value || todayStr());
    renderGrid();
  }
</script>
</body>
</html>
